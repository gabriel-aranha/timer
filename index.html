<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>House Timer</title>
    <style>
        body {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            font-family: Arial, sans-serif;
            background-color: #f5f5f5;
        }
        .timer-container {
            text-align: center;
            width: 80%;
            max-width: 600px;
        }
        #display {
            font-size: 4em;
            margin: 20px;
        }
        .controls {
            margin: 20px 0;
        }
        button {
            font-size: 1.2em;
            margin: 5px;
            padding: 10px 20px;
            cursor: pointer;
        }
        .laps {
            max-height: 200px;
            overflow-y: auto;
            margin: 20px 0;
            text-align: left;
        }
        .lap-entry {
            padding: 5px;
            border-bottom: 1px solid #eee;
        }
        #sessionName {
            font-size: 1.2em;
            padding: 5px;
            margin: 10px 0;
            width: 200px;
        }
        .timer-container {
            background-color: white;
            padding: 2em;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        .export-btn {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 20px;
        }
        .export-btn:hover {
            background-color: #45a049;
        }
    </style>
</head>
<body>
    <div class="timer-container">
        <input type="text" id="sessionName" placeholder="House Number">
        <div id="display">00:00:000</div>
        <div class="controls">
            <button onclick="startTimer()">Start</button>
            <button onclick="pauseTimer()">Pause</button>
            <button onclick="recordLap()">Lap</button>
            <button onclick="resetTimer()">Reset</button>
        </div>
        <div class="laps" id="lapsContainer"></div>
        <button onclick="exportToCSV()" class="export-btn">Export to CSV</button>
    </div>

    <script>
        let timer;
        let startTime;
        let isRunning = false;
        let laps = [];
        let lastLapTime;
        
        function formatTime(timestamp) {
            if (!timestamp) return "00:00:000";
            const totalMs = timestamp instanceof Date ? timestamp.getTime() : timestamp;
            const minutes = Math.floor(totalMs / 60000);
            const seconds = Math.floor((totalMs % 60000) / 1000);
            const ms = totalMs % 1000;
            return `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}:${String(ms).padStart(3, '0')}`;
        }
        
        function getCurrentTime() {
            return new Date().getTime() - startTime;
        }

        function updateDisplay() {
            if (isRunning) {
                document.getElementById('display').textContent = formatTime(getCurrentTime());
            }
        }

        function startTimer() {
            if (!isRunning) {
                isRunning = true;
                startTime = new Date().getTime();
                lastLapTime = startTime;
                timer = setInterval(updateDisplay, 10); // Update every 10ms for millisecond precision
            }
        }

        function pauseTimer() {
            clearInterval(timer);
            isRunning = false;
        }

        function resetTimer() {
            pauseTimer();
            startTime = null;
            lastLapTime = null;
            laps = [];
            document.getElementById('display').textContent = "00:00:000";
            document.getElementById('lapsContainer').innerHTML = '';
        }

        function recordLap() {
            if (isRunning) {
                const currentTime = new Date().getTime();
                const lapTime = currentTime - lastLapTime;
                const totalTime = currentTime - startTime;
                
                laps.push({
                    timestamp: currentTime,
                    totalTime: totalTime,
                    lapTime: lapTime
                });
                
                lastLapTime = currentTime;
                updateLapsDisplay();
            }
        }

        function updateLapsDisplay() {
            const lapsContainer = document.getElementById('lapsContainer');
            const houseName = document.getElementById('sessionName').value || 'Unnamed House';
            let lapsHTML = `<h3>${houseName}</h3>`;
            
            laps.forEach((lap, index) => {
                const cycleTime = index > 0 ? formatTime(lap.lapTime) : formatTime(lap.totalTime);
                lapsHTML += `
                    <div class="lap-entry">
                        Lap ${index + 1} - Time: ${formatTime(lap.totalTime)} - Cycle: ${cycleTime}
                    </div>`;
            });
            
            lapsContainer.innerHTML = lapsHTML;
        }

        function exportToCSV() {
            const houseName = document.getElementById('sessionName').value || 'Unnamed House';
            
            // Function to escape and quote CSV fields
            function escapeField(field) {
                return `"${field.toString().replace(/"/g, '""')}"`;
            }
            
            // Calculate cycle times using lapTime values
            function calculateCycleTimes() {
                const cycleTimes = {};
                // First cycle is first lap's total time (from start)
                if (laps.length > 0) {
                    cycleTimes[1] = laps[0].totalTime;
                }
                // For each subsequent pair, use the actual lap times
                for (let i = 1; i < laps.length; i++) {
                    if (i % 2 === 1) { // For laps 2-3, 4-5, etc.
                        const cycleNumber = Math.floor(i/2) + 2;
                        cycleTimes[cycleNumber] = laps[i].lapTime;
                    }
                }
                return cycleTimes;
            }
            
            // Create header row
            const headerRow = ['House', 'Start Timer'];
            for (let i = 1; i <= laps.length; i++) {
                headerRow.push(`Lap ${i}`);
                // Add Cycle Time after odd-numbered laps (1,3,5,...)
                if (i % 2 === 1) {
                    const cycleNumber = Math.ceil(i/2);
                    headerRow.push(`Cycle Time ${cycleNumber}`);
                }
            }
            
            // Create data row
            const dataRow = [houseName, '00:00:000'];
            const cycleTimes = calculateCycleTimes();
            
            laps.forEach((lap, index) => {
                dataRow.push(formatTime(lap.totalTime));
                // Add cycle time after odd-numbered laps
                if (index % 2 === 0) {
                    const cycleNumber = Math.floor(index/2) + 1;
                    if (cycleTimes[cycleNumber]) {
                        dataRow.push(formatTime(cycleTimes[cycleNumber]));
                    }
                }
            });
            
            // Quote all fields and join with proper line endings
            const csvContent = 
                headerRow.map(escapeField).join(',') + 
                '\n' + 
                dataRow.map(escapeField).join(',');

            // Create and trigger download
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            if (navigator.msSaveBlob) { // IE 10+
                navigator.msSaveBlob(blob, 'timer_data.csv');
            } else {
                link.href = URL.createObjectURL(blob);
                link.download = 'timer_data.csv';
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }
    </script>
</body>
</html>